<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="IE=edge" http-equiv="X-UA-Compatible" />
  <title>Lucene!</title>
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <link href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" rel="stylesheet" />
  <style>
    .box {
      padding: 1em;
    }

    .button-bar {
      margin: 0.5em 0 0 0;
    }

    .button-small {
      font-size: 60%;
    }

    .file-list {
      list-style-type: none;
      overflow: auto;
    }

    html,
    body {
      height: 100%;
    }

    .upper {
      min-height: 40%;
    }

    .lower {
      min-height: 60%;
    }
  </style>
</head>

<body>
  <div class="pure-g upper">
    <div class="pure-u-1-2">
      <form action="/upload" class="pure-form  box" enctype="multipart/form-data" id="upload-form" method="post">
        <fieldset>
          <legend>Upload</legend>

          <!--  Add support for multiple? -->
          <input id="file" name="file" type="file" multiple />
          <button class="pure-button pure-button-primary" type="submit">
            Add file to index
          </button>
        </fieldset>
      </form>
      <ul id="file-list" class="file-list">

      </ul>
    </div>
    <div class="pure-u-1-2">
      <form class="pure-form box" id="search-form">
        <fieldset>
          <legend>Search in index</legend>

          <input placeholder="search string..." type="search" id="term" name="term" />

          <button class="pure-button pure-button-primary" type="submit" id="search-btn" disabled>
            Search
          </button>
        </fieldset>
      </form>
      <div id="search-results-box" style="display:none">
        <table class="pure-table">
          <thead>
            <tr>
              <th>Word</th>
              <th>Hits</th>
            </tr>
          </thead>
          <tbody id="search-results">

          </tbody>
        </table>
        <div class="button-bar">
          <button class="pure-button button-small" id="clear-search-btn">
            Clear Search
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="lower">
    <h1>Placeholder for cool diagram!</h1>
  </div>
</body>

<script>
  // Poorest proxy possible!
  const url_base = "http://localhost:8080";

  function addSearchResult(word, searchResult) {
    document.getElementById('search-results-box').style.display = '';

    const searchResultList = document.getElementById("search-results");
    const resultsRow = document.createElement("tr");
    const wordCell = document.createElement("td");
    wordCell.appendChild(document.createTextNode(word));
    const hitsCell = document.createElement("td");
    hitsCell.appendChild(document.createTextNode(`${searchResult.totalHits}`));
    resultsRow.appendChild(wordCell);
    resultsRow.appendChild(hitsCell);
    searchResultList.appendChild(resultsRow);
  }

  function clearSearchResult() {
    document.getElementById('search-results-box').style.display = 'none';

    const searchResultList = document.getElementById('search-results');
    while (searchResultList.firstChild) {
      searchResultList.removeChild(searchResultList.firstChild);
    }

  }

  function addFileToFileList(file) {
    const fileList = document.getElementById("file-list");
    document.getElementById("search-btn").disabled = false;
    const newFileRow = document.createElement("li");
    newFileRow.appendChild(document.createTextNode(`${file.name} (${file.size}) bytes`));
    fileList.appendChild(newFileRow);
  }

  function search(e) {
    const term = document.getElementById("term").value;

    fetch(`${url_base}/search/${term}`)
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        throw new Error(
          `Network response was not ok... Got ${response.status} ${response.statusText}`
        );
      })
      .then(searchResult => {
        console.log(JSON.stringify(searchResult));
        addSearchResult(term, searchResult);
      })
      .catch(e => {
        console.log(e);
      });

    e.preventDefault();
  }

  function uploadFiles(e) {
    const fileField = document.getElementById("file");

    const formData = new FormData();
    for (var i = 0; i < fileField.files.length; i++) {
      formData.append("files", fileField.files[i]);
    }

    fetch(`${url_base}/upload`, {
      method: 'POST',
      body: formData
    })
      .then(response => {
        clearSearchResult();
        for (var i = 0; i < fileField.files.length; i++) {
          const file = fileField.files[i];
          addFileToFileList(file);
          console.log(`Uploaded file ${file.name} (${file.size}) bytes`);
        }
        fileField.value = '';
      })
      .catch(error => console.error('Error:', error));

    e.preventDefault();
  }

  document.getElementById("search-form").addEventListener("submit", search);
  document.getElementById("upload-form").addEventListener("submit", uploadFiles);
  document.getElementById("clear-search-btn").addEventListener("click", clearSearchResult);

</script>

</html>